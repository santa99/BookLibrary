@using Contracts.Models
@using View.Services
@using Index = View.Pages.Index

<tr style="text-align: left;" @onclick="ClickRow">
    <td>
        @if (Editing())
        {
            <input type="checkbox" @bind="Checked" @onclick="Check"/>
        }
        @Book.Id
    </td>
    <td>
        @if (Editing())
        {
            <input type="text" name="name" value="@_BookEdit.Name" @onchange="OnNameChanged"/>
        }
        else
        {
            @Book.Name
        }
    </td>
    <td>
        @if (Editing())
        {
            <input type="text" name="author" value="@_BookEdit.Author" @onchange="OnAuthorChanged"/>
        }
        else
        {
            @Book.Author
        }
    </td>
    <td>
        <div>@(Book.Borrowed != null ? @BorrowedBy(Book.Borrowed) : "Free")</div>
    </td>
</tr>


@code {
    [Parameter] public Index Root { get; set; }
    [Parameter] public BookModel Book { get; set; }
    [Parameter] public EventCallback<BookModel> OnBorrowBook { get; set; }
    [Parameter] public EditState EditState { get; set; }
    [Parameter] public bool Checked { get; set; }
    [Parameter] public EventCallback<EditableTableEntry> OnChecked { get; set; }
    
    private BookModel? _BookEdit { get; set; }

    private bool _isEdited;
    private bool _dirty;

    private async Task<bool> Check()
    {
        await OnChecked.InvokeAsync(this);
        return Checked;
    }

    private bool Editing()
    {
        return @EditState.IsEditMode && EditState.IsMeEdit(this);
    }

    protected override Task OnInitializedAsync()
    {
        Root.Add(this);
        return base.OnInitializedAsync();
    }

    private async Task ClickRow()
    {
        if (EditState.IsEditMode)
        {
            EnterEdit();
            return;
        }

        await OnBorrowBook.InvokeAsync(Book);
    }

    private void EnterEdit()
    {
        if (_isEdited)
        {
            return;
        }
            
        _isEdited = true;
        _BookEdit = new BookModel
        {
            Id = Book.Id,
            Name = Book.Name,
            Author = Book.Author,
            Borrowed = Book.Borrowed
        };
        EditState.StartEditEntry(this);
    }

    private void OnNameChanged(ChangeEventArgs e)
    {
        var tmp = e.Value?.ToString();
        var bookName = !(string.IsNullOrWhiteSpace(tmp)) ? tmp : Book.Name;
        if (bookName == Book.Name)
        {
            return;
        }
        _dirty = true;
        _BookEdit.Name = bookName;
    }

    private void OnAuthorChanged(ChangeEventArgs e)
    {
        var tmp = e.Value?.ToString();
        var bookAuthor = !(string.IsNullOrWhiteSpace(tmp)) ? tmp : Book.Author;
        if (bookAuthor == Book.Author)
        {
            return;
        }
        _dirty = true;
        _BookEdit.Author = bookAuthor;
    }

    public async Task SaveChanges(BooksService booksService)
    {
        if (!_dirty || _BookEdit == null)
        {
            _isEdited = false;
            return;
        }

        await booksService.UpdateBook(_BookEdit);

        UpdateEntry(_BookEdit);
        
        _dirty = false;
        _isEdited = false;
        Checked = false;
    }

    public async Task DiscardChanges()
    {
        if (!_dirty || _BookEdit == null)
        {
            _isEdited = false;
            return;
        }

        _BookEdit = new BookModel
        {
            Id = Book.Id,
            Name = Book.Name,
            Author = Book.Author,
            Borrowed = Book.Borrowed
        };

        _dirty = false;
        _isEdited = false;
        Checked = false;

        await Task.CompletedTask;
    }

    internal void UpdateEntry(BookModel bookModel)
    {
        Book.Name = bookModel.Name;
        Book.Author = bookModel.Author;
        Book.Borrowed = bookModel.Borrowed;
    }

    private static string BorrowedBy(BorrowModel borrowModel)
    {
        return "'" + borrowModel.FirstName + " " + borrowModel.LastName + "' borrowed on [" + borrowModel.From.ToString("dd MMMM yyyy") + "]";
    }
    
}